var J = {
  "directed": true, 
  "project_name": "Jeopardy", 
  "links": [
    {
      "source": 0, 
      "target": 4, 
      "w": 1.0
    }, 
    {
      "source": 0, 
      "target": 16, 
      "w": 1.0
    }, 
    {
      "source": 6, 
      "target": 0, 
      "w": 0.07692307692307693
    }, 
    {
      "source": 6, 
      "target": 7, 
      "w": 0.01639344262295082
    }, 
    {
      "source": 7, 
      "target": 2, 
      "w": 1.0
    }, 
    {
      "source": 7, 
      "target": 12, 
      "w": 1.0
    }, 
    {
      "source": 12, 
      "target": 3, 
      "w": 1.0
    }, 
    {
      "source": 12, 
      "target": 13, 
      "w": 1.0
    }, 
    {
      "source": 12, 
      "target": 15, 
      "w": 1.0
    }, 
    {
      "source": 12, 
      "target": 10, 
      "w": 1.0
    }, 
    {
      "source": 14, 
      "target": 0, 
      "w": 0.9230769230769231
    }, 
    {
      "source": 14, 
      "target": 7, 
      "w": 0.9836065573770492
    }
  ], 
  "multigraph": false, 
  "graph": [], 
  "nodes": [
    {
      "name": "category", 
      "sample_text": [
        "ZOOLOGY", 
        "GEMS & JEWELRY", 
        "THE SURF REPORT", 
        "MUSIC VIDEOS", 
        "NEWSPAPERS & MAGAZINES", 
        "E BEFORE I", 
        "LITERATURE", 
        "FAMOUS NAMES", 
        "CHEMISTRY 101", 
        "LOSING YOUR HEAD IN THE MOVIES", 
        "WAR BATTLES\n\n(Alex: We'll give you [*], you name the war in which they occurred.)", 
        "WORD & PHRASE ORIGINS", 
        "THE EARLY 20th CENTURY", 
        "AMERICAN WRITERS", 
        "IT'S A TEAM THING", 
        "NOT NO. 1", 
        "POPULATIONS", 
        "WHIRLED CAPITALS\n\n(Alex: We'll have anagrams for you.)", 
        "THE ANATOMY OF EVEL", 
        "THE TOWER", 
        "THE HANGED MAN", 
        "THE MAGICIAN", 
        "WANDS, CUPS, SWORDS, PENTACLES", 
        "THE LOVERS", 
        "\"DEATH\"", 
        "FOOD\n\n(Alex: We all love food.)", 
        "DUDE, WHERE'S MY CZAR?", 
        "LONI, DONNY OR YANNI", 
        "NAMED AFTER JFK", 
        "WHAT 4"
      ], 
      "depth": 2, 
      "y": 90.0, 
      "x": 254.54, 
      "fixed": 0
    }, 
    {
      "name": "contestants", 
      "sample_text": [
        ""
      ], 
      "depth": 1, 
      "y": 18.0, 
      "x": 459.54, 
      "fixed": 0
    }, 
    {
      "name": "clue_text", 
      "sample_text": [
        "(\nSofia of the Clue Crew reports from the San Diego Zoo.\n)  All apes, including the siamang, are, un", 
        "Introduced in 1886, a classic 6-prong setting for engagement rings is named for this Manhattan jewel", 
        "Dude!  There are 30-footers breakin' at Waimea Bay on the North Shore in this state", 
        "Guy Ritchie directed the controversial video for her \"What It Feels Like For A Girl\"", 
        "In the '60s Katharine Graham took over as publisher of this newspaper & hired Ben Bradlee as managin", 
        "A noisy ghost", 
        "Hermit crabs have 2 pairs of antennae & 4 pairs of these", 
        "It's said that pins weren't worn on kilts until this 19th c. queen offered one to a Highland soldier", 
        "Bummer!  In 2001 a pro event on the southern tip of East Java in this country was scrubbed due to ci", 
        "Destiny's Child sings in a lagoon in this jungle-set video", 
        "In 2001 McCall's magazine was relaunched with this TV talk show host at the helm & renamed for her", 
        "Bogus or fake, like some money", 
        "(\nCheryl of the Clue Crew reports from SeaWorld.\n)  The otter is the most aquatically adapted of thi", 
        "Most folks think of this January birthstone as reddish, but lovely orange ones are found in Namibia ", 
        "It's surfin' among the future sushi where you hit the waves at Chiba's Torami Beach in this country", 
        "This actor dances his way through the Fatboy Slim video \"Weapon Of Choice\"", 
        "This alternative music magazine founded by Bob Guccione Jr. celebrated its 15th anniversary in 2000", 
        "\"Magic Kingdom\" city", 
        "Strains of the Norway species of this animal are the ones used in labs", 
        "Often green or white, nephrite is a type of this gemstone closely associated with Asia", 
        "Whoa!  I took a donut (wiped out) at Burleigh during the Billabong Pro on this country's Gold Coast", 
        "Lingerie-clad Christina Aguilera, Mya, Lil' Kim & Pink all appear in this video", 
        "Roger Ebert writes movie reviews for this Midwestern paper", 
        "A valuable family possession handed down from one generation to the next", 
        "(\nSarah of the Clue Crew reports from the San Diego Zoo.\n)  Unlike humans,\nsheep\ndon't have these fr", 
        "\"Jurassic Park\" made this fossilized resin really popular; maybe you'll find some dinosaur DNA in yo", 
        "Head to Jeffreys Bay & pull off a sick floater in this country, whose administrative capital is Pret", 
        "5 of this woman's 6 MTV Video Music Award nominations were courtesy of her work with Eminem on \"Stan", 
        "After the demise of Sassy, founding editor Ms. Pratt launched this magazine that bears her first nam", 
        "The only U.S. President whose last name fits the category"
      ], 
      "depth": 3, 
      "y": 162.0, 
      "x": 374.54, 
      "fixed": 0
    }, 
    {
      "name": "clue_unstuck", 
      "sample_text": [
        ""
      ], 
      "depth": 4, 
      "y": 234.0, 
      "x": 260.54, 
      "fixed": 0
    }, 
    {
      "name": "category_comments", 
      "sample_text": [
        ""
      ], 
      "depth": 3, 
      "y": 162.0, 
      "x": 82.543, 
      "fixed": 0
    }, 
    {
      "name": "score_player_nickname", 
      "sample_text": [
        "Tony", 
        "Brittany", 
        "Matt", 
        "Tony", 
        "Brittany", 
        "Matt", 
        "Tony", 
        "Brittany", 
        "Matt", 
        "Tony", 
        "Brittany", 
        "Matt", 
        "Tony", 
        "Brittany", 
        "Matt", 
        "Ken", 
        "Mary", 
        "Frank", 
        "Ken", 
        "Mary", 
        "Frank", 
        "Ken", 
        "Mary", 
        "Frank", 
        "Ken", 
        "Mary", 
        "Frank", 
        "Ken", 
        "Mary", 
        "Frank"
      ], 
      "depth": 1, 
      "y": 18.0, 
      "x": 622.54, 
      "fixed": 0
    }, 
    {
      "name": "final_round", 
      "sample_text": [
        ""
      ], 
      "depth": 1, 
      "y": 18.0, 
      "x": 257.54, 
      "fixed": 0
    }, 
    {
      "name": "clue", 
      "sample_text": [
        "$100\n\n3\n\n\n\n\n\n\n\n(\nSofia of the Clue Crew reports from the San Diego Zoo.\n)  All apes, including the s", 
        "$100\n\n2\n\n\n\n\n\n\n\nIntroduced in 1886, a classic 6-prong setting for engagement rings is named for this ", 
        "$100\n\n26\n\n\n\n\n\n\n\nDude!  There are 30-footers breakin' at Waimea Bay on the North Shore in this state", 
        "$100\n\n1\n\n\n\n\n\n\n\nGuy Ritchie directed the controversial video for her \"What It Feels Like For A Girl\"", 
        "$100\n\n12\n\n\n\n\n\n\n\nIn the '60s Katharine Graham took over as publisher of this newspaper & hired Ben Br", 
        "$100\n\n17\n\n\n\n\n\n\n\nA noisy ghost", 
        "$200\n\n8\n\n\n\n\n\n\n\nHermit crabs have 2 pairs of antennae & 4 pairs of these", 
        "$200\n\n22\n\n\n\n\n\n\n\nIt's said that pins weren't worn on kilts until this 19th c. queen offered one to a ", 
        "$200\n\n27\n\n\n\n\n\n\n\nBummer!  In 2001 a pro event on the southern tip of East Java in this country was sc", 
        "$200\n\n4\n\n\n\n\n\n\n\nDestiny's Child sings in a lagoon in this jungle-set video", 
        "$200\n\n13\n\n\n\n\n\n\n\nIn 2001 McCall's magazine was relaunched with this TV talk show host at the helm & r", 
        "$200\n\n18\n\n\n\n\n\n\n\nBogus or fake, like some money", 
        "$300\n\n9\n\n\n\n\n\n\n\n(\nCheryl of the Clue Crew reports from SeaWorld.\n)  The otter is the most aquatically", 
        "$300\n\n23\n\n\n\n\n\n\n\nMost folks think of this January birthstone as reddish, but lovely orange ones are f", 
        "$300\n\n28\n\n\n\n\n\n\n\nIt's surfin' among the future sushi where you hit the waves at Chiba's Torami Beach ", 
        "$300\n\n5\n\n\n\n\n\n\n\nThis actor dances his way through the Fatboy Slim video \"Weapon Of Choice\"", 
        "$300\n\n14\n\n\n\n\n\n\n\nThis alternative music magazine founded by Bob Guccione Jr. celebrated its 15th anni", 
        "$300\n\n19\n\n\n\n\n\n\n\n\"Magic Kingdom\" city", 
        "$400\n\n10\n\n\n\n\n\n\n\nStrains of the Norway species of this animal are the ones used in labs", 
        "$400\n\n24\n\n\n\n\n\n\n\nOften green or white, nephrite is a type of this gemstone closely associated with As", 
        "$400\n\n29\n\n\n\n\n\n\n\nWhoa!  I took a donut (wiped out) at Burleigh during the Billabong Pro on this count", 
        "$400\n\n6\n\n\n\n\n\n\n\nLingerie-clad Christina Aguilera, Mya, Lil' Kim & Pink all appear in this video", 
        "$400\n\n15\n\n\n\n\n\n\n\nRoger Ebert writes movie reviews for this Midwestern paper", 
        "$400\n\n20\n\n\n\n\n\n\n\nA valuable family possession handed down from one generation to the next", 
        "$500\n\n11\n\n\n\n\n\n\n\n(\nSarah of the Clue Crew reports from the San Diego Zoo.\n)  Unlike humans,\nsheep\ndon", 
        "$500\n\n25\n\n\n\n\n\n\n\n\"Jurassic Park\" made this fossilized resin really popular; maybe you'll find some di", 
        "$500\n\n30\n\n\n\n\n\n\n\nHead to Jeffreys Bay & pull off a sick floater in this country, whose administrative", 
        "$500\n\n7\n\n\n\n\n\n\n\n5 of this woman's 6 MTV Video Music Award nominations were courtesy of her work with ", 
        "$500\n\n16\n\n\n\n\n\n\n\nAfter the demise of Sassy, founding editor Ms. Pratt launched this magazine that bea", 
        "DD: $1,700\n\n21\n\n\n\n\n\n\n\nThe only U.S. President whose last name fits the category"
      ], 
      "depth": 2, 
      "y": 90.0, 
      "x": 372.54, 
      "fixed": 0
    }, 
    {
      "name": "score_remarks", 
      "sample_text": [
        ""
      ], 
      "depth": 1, 
      "y": 18.0, 
      "x": 797.54, 
      "fixed": 0
    }, 
    {
      "name": "game_dynamics", 
      "sample_text": [
        ""
      ], 
      "depth": 1, 
      "y": 18.0, 
      "x": 946.54, 
      "fixed": 0
    }, 
    {
      "name": "clue_order_number", 
      "sample_text": [
        "3", 
        "2", 
        "26", 
        "1", 
        "12", 
        "17", 
        "8", 
        "22", 
        "27", 
        "4", 
        "13", 
        "18", 
        "9", 
        "23", 
        "28", 
        "5", 
        "14", 
        "19", 
        "10", 
        "24", 
        "29", 
        "6", 
        "15", 
        "20", 
        "11", 
        "25", 
        "30", 
        "7", 
        "16", 
        "21"
      ], 
      "depth": 4, 
      "y": 234.0, 
      "x": 415.54, 
      "fixed": 0
    }, 
    {
      "name": "score_positive", 
      "sample_text": [
        "$1,600", 
        "$1,300", 
        "$200", 
        "$2,700", 
        "$1,200", 
        "$4,200", 
        "$5,900", 
        "$3,800", 
        "$2,000", 
        "$7,100", 
        "$7,593", 
        "$4,600", 
        "$5,500", 
        "$5,500", 
        "$4,200", 
        "$0", 
        "$200", 
        "$13,200", 
        "$400", 
        "$2,400", 
        "$40,000", 
        "$3,200", 
        "$4,800", 
        "$50,000", 
        "$6,300", 
        "$3,199", 
        "$30,800", 
        "$3,200", 
        "$4,800", 
        "$4,000"
      ], 
      "depth": 1, 
      "y": 18.0, 
      "x": 1095.5, 
      "fixed": 0
    }, 
    {
      "name": "clue_header", 
      "sample_text": [
        "$100\n\n3", 
        "$100\n\n2", 
        "$100\n\n26", 
        "$100\n\n1", 
        "$100\n\n12", 
        "$100\n\n17", 
        "$200\n\n8", 
        "$200\n\n22", 
        "$200\n\n27", 
        "$200\n\n4", 
        "$200\n\n13", 
        "$200\n\n18", 
        "$300\n\n9", 
        "$300\n\n23", 
        "$300\n\n28", 
        "$300\n\n5", 
        "$300\n\n14", 
        "$300\n\n19", 
        "$400\n\n10", 
        "$400\n\n24", 
        "$400\n\n29", 
        "$400\n\n6", 
        "$400\n\n15", 
        "$400\n\n20", 
        "$500\n\n11", 
        "$500\n\n25", 
        "$500\n\n30", 
        "$500\n\n7", 
        "$500\n\n16", 
        "DD: $1,700\n\n21"
      ], 
      "depth": 3, 
      "y": 162.0, 
      "x": 488.54, 
      "fixed": 0
    }, 
    {
      "name": "clue_value", 
      "sample_text": [
        "$100", 
        "$100", 
        "$100", 
        "$100", 
        "$100", 
        "$100", 
        "$200", 
        "$200", 
        "$200", 
        "$200", 
        "$200", 
        "$200", 
        "$300", 
        "$300", 
        "$300", 
        "$300", 
        "$300", 
        "$300", 
        "$400", 
        "$400", 
        "$400", 
        "$400", 
        "$400", 
        "$400", 
        "$500", 
        "$500", 
        "$500", 
        "$500", 
        "$500", 
        "$200"
      ], 
      "depth": 4, 
      "y": 234.0, 
      "x": 562.54, 
      "fixed": 0
    }, 
    {
      "name": "round", 
      "sample_text": [
        ""
      ], 
      "depth": 1, 
      "y": 18.0, 
      "x": 360.54, 
      "fixed": 0
    }, 
    {
      "name": "clue_value_daily_double", 
      "sample_text": [
        ""
      ], 
      "depth": 4, 
      "y": 234.0, 
      "x": 728.54, 
      "fixed": 0
    }, 
    {
      "name": "category_name", 
      "sample_text": [
        "ZOOLOGY", 
        "GEMS & JEWELRY", 
        "THE SURF REPORT", 
        "MUSIC VIDEOS", 
        "NEWSPAPERS & MAGAZINES", 
        "E BEFORE I", 
        "LITERATURE", 
        "FAMOUS NAMES", 
        "CHEMISTRY 101", 
        "LOSING YOUR HEAD IN THE MOVIES", 
        "WAR BATTLES", 
        "WORD & PHRASE ORIGINS", 
        "THE EARLY 20th CENTURY", 
        "AMERICAN WRITERS", 
        "IT'S A TEAM THING", 
        "NOT NO. 1", 
        "POPULATIONS", 
        "WHIRLED CAPITALS", 
        "THE ANATOMY OF EVEL", 
        "THE TOWER", 
        "THE HANGED MAN", 
        "THE MAGICIAN", 
        "WANDS, CUPS, SWORDS, PENTACLES", 
        "THE LOVERS", 
        "\"DEATH\"", 
        "FOOD", 
        "DUDE, WHERE'S MY CZAR?", 
        "LONI, DONNY OR YANNI", 
        "NAMED AFTER JFK", 
        "WHAT 4"
      ], 
      "depth": 3, 
      "y": 162.0, 
      "x": 248.54, 
      "fixed": 0
    }
  ]
};

var f_graph = "input_graph.json";

// size of the diagram
var width = $(document).width();
var height = 0.5*$(document).height();

var radius = 10;
var fill = d3.scale.category20();

var y_delta_space = 50;
var charge = 250;

var c1 = "#1f77b4";
var c2 = "#ff7f0e";
var c2 = "#EEB4B4";

var svg = d3.select("#chart").append("svg")
    .attr("width", width)
    .attr("height", height)
    .call(d3.behavior.zoom().on("zoom", redraw))
    .on("dblclick.zoom", null);


var vis = svg
    .append('svg:g');

// define arrow markers for graph links
vis.append('svg:defs').append('svg:marker')
    .attr('id', 'end-arrow')
    .attr('viewBox', '0 -5 10 10')
    .attr('refX', 6)
    .attr('markerWidth', 5)
    .attr('markerHeight', 6)
    .attr('orient', 'auto')
  .append('svg:path')
    .attr('d', 'M0,-5L10,0L0,5')
    .attr('fill', '#444');

var force = d3.layout.force()
    .gravity(.05)
    .distance(100)
    .charge(-charge)
    .linkStrength(.01)
    .size([width, height])
    .on('tick',tick);

var node = vis.selectAll(".node");
var path = {};

var userList;

d3.json("", function(error, json) {

    var json = J;
    
    $("#project_name").text( json.project_name );

    // Load the text into search_box
    var box = $("#search_box .list");

    $(json.nodes).each(function() {
        name = this.name;
        text = this.sample_text;
        html = ("<li><h3 class='search_name'>"+name+"</h3>"+
                "<p class='search_text'>"+text+"</p></li>");
        obj = $(html).on("click", select_search_text);
        box.append(obj);
    });

    var options = {
        valueNames: [ 'search_name', 'search_text' ]
    };
    userList = new List('search_box', options);


    force
        .nodes(json.nodes)
        .links(json.links)
        .start();

    node = node.data(json.nodes)
        .enter().append("g")
        .attr("class", "node")
        .attr("selected",0)
        .attr("id",function(d){return "node_"+d.name})
        .attr("name",function(d) {return d.name;})
        .call(force.drag);

    node.append('circle')
        .attr("r", radius)
        .style("fill", function(d) { return c1; })

    node.append("text")
        .attr("dx", 12)
        .attr("dy", ".35em")
        .text(function(d) { return d.name });

    node.on("mouseover", highlight_node);
    node.on("mouseout",  unhighlight_node);
    node.on("click", select_node);
    node.on("dblclick",delete_node);

    path = vis.append("svg:g").selectAll("path")
        .data(force.links())
        .enter().append("svg:path")
        .attr("i", function(d) { return d.source.index; })
        .attr("j", function(d) { return d.target.index; })
        .attr("source", function(d) { return d.source.name; })
        .attr("target", function(d) { return d.target.name; })
        .attr("class", "link")
        .attr("marker-end", "url(#end-arrow)");
});

function select_node(d) {
    var obj = d3.select(this);
    highlight_toggle(obj);

    name = $(this).attr("name");
    $(".search_name").each(function() {
        if( $(this).text() == name ) {
            $(this).parent().toggleClass("search_selected");            
            console.log($(this).text());
        }
    });

}

function highlight_toggle(obj) {
    var is_selected = obj.attr("selected");   

    if(is_selected=="0") {
        obj.attr("selected",1)

        obj.select("circle")
            .style("fill", c2)
            .style("stroke-width",3) 
            .style("stroke","black") ;
    };

    if(is_selected=="1") {
        obj.attr("selected",0)

        obj.select("circle")
            .style("fill", c1)
            .style("stroke-width",0);
        
    };
}

function delete_node(d) {
    var x = d.index;

    $(".link").each(function() { 
        var i = this.getAttribute("i");
        var j = this.getAttribute("j");
        if(i==x || j==x) {
            edge = d3.select(this);
            edge.remove();
        }
    } );

    var obj = d3.select(this);
    obj.remove();
    force.start();
}

function highlight_node(d) {

    $("text").attr("class", "faded");
    var obj = d3.select(this);

    // The class is used to remove the additional text later
    var info = obj.append('text')
        .classed('info', true)
        .attr("text-anchor", "middle")
        .attr('x', -20)
        .attr('y', 35)
        .style("font-size", "30px")
        .text(d.name);

    //$("#project_text").html(d.sample_text);
    $("#search_button").val(d.name);
    userList.search(d.name);
    
    userList.filter(function(item) {
        item_name = item.values().search_name;
        return (item_name == d.name);
    }); 
    userList.filter();
    


};

function unhighlight_node(d) {
    d3.select(this).select('text.info').remove();
    $("text").attr("class", "");
}

function tick(e) {

    var k = .5*e.alpha;
    node.attr("transform", function(d) { 
        dy = k*(d.y-((d.depth-0.5)*y_delta_space));
        d.y -= dy;
    });

    path.attr('d', function(d) {
        var deltaX = d.target.x - d.source.x,
        deltaY = d.target.y - d.source.y,
        dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
        normX = deltaX / dist,
        normY = deltaY / dist,
        sourcePadding = d.left ? 17 : 12,
        targetPadding = d.right ? 17 : 12,
        sourceX = d.source.x + (sourcePadding * normX),
        sourceY = d.source.y + (sourcePadding * normY),
        targetX = d.target.x - (targetPadding * normX),
        targetY = d.target.y - (targetPadding * normY);
        return 'M' + sourceX + ',' + sourceY + 'L' + targetX + ',' + targetY;
    });

    node.attr("transform", function(d) { 
        return "translate(" + d.x + "," + d.y + ")"; });

};

/***************************************************************/

function save_as_svg() {
    // get svg element.
    var svg = document.getElementById("chart");

    //get svg source.
    var serializer = new XMLSerializer();
    var source = serializer.serializeToString(svg);


    //add name spaces.
    if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
        source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
    }
    if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
        source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
    }

    //add xml declaration
    source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

    //convert svg source to URI data scheme.
    var url = "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source);

    var dl = document.createElement('a');
    dl.setAttribute('href', url);
    dl.setAttribute('download', 'output_graph.svg');
    dl.click();

    console.log(source);

};

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */

function redraw() {
    vis.attr("transform",
             "translate(" + d3.event.translate + ")"
             + " scale(" + d3.event.scale + ")");
    userList.search();    
}

function select_search_text() {
    name = $(".search_name", this).text();
    highlight_toggle(d3.select("#node_"+name));

    $(this).toggleClass("search_selected");
}

